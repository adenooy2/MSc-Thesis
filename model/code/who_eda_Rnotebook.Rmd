---
title: "Exploratory Data Analysis"
output:
  pdf_document: 
    number_sections: true
    fig_width: 6
    fig_height: 4
    fig_caption: true
    fig_crop: true
  html_notebook: 
    number_sections: true
---
# Personal Information
Name: Alexandra de Nooy \
Student ID: 14581728\
Email: alexandra.de.nooy@student.uva.nl or denooy.alex@gmail.com\
Submitted on: 22/03/2023\
Github link: https://github.com/adenooy2/MSc-Thesis.git

# Data Context
This exploratory data analysis is conducted usinf R and RStudio. There are two main sets of data to be considered, linked to the two main sections of the project.

The first set of data represents the baseline or standard of care output runs produced by the existing patient pathway model. For the baseline there are 15 data output files (in csv format). Multiple files had been generated to account for model stochasticity, with the results of each simulation being based on a different set of random probabilities. The data files have a consistent structure and represent the population of indiviudals who move through the TB diagnostic patient pathway. In this, each column represents either a patient disease status or a point in the patient pathway that the indiviudal may or may not have reached.

The second data set consists of TB burden estimates for Kenya produced by the World Heath Organization as well as the accompanying data dictionary. The estimates cover a range of data variables and their estimated values between the years 2000 and 2022. Several key variables include estimates on TB incidence (new cases), notifications (diagnoses) and deaths. Estimates are also provided for different groups of individuals (for example HIV postive patients) and for different tpes of TB.


```{r, echo=FALSE,message=FALSE}
library(tidyverse)
library(tidyverse)
library(readxl)
library(ggplot2)
library(stringr)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=55),tidy=TRUE)
options(scipen=999,width=70)

rm(list=ls())


```

# Data Description: Baseline TB model

## Load baseline data

```{r}
#Set path to baseline data
baseline_path="/Users/adenooy/Library/CloudStorage/OneDrive-Personal/UVA/Thesis/MSc-Thesis/data/static/output/"

#Determine how many files
files=list.files(baseline_path)
num_files=length(files)
print(paste("Number of baseline files: " ,num_files,sep=""))
```

## Explore variables and format of one baseline file
Each baseline data file represents a population of individuals (one per row) and various columns representing the different states or points in the patient pathway reached by each individual. 

### File Structure

```{r}
b_data=read_excel(paste(baseline_path,files[1],sep=""))

print(paste("Each data file consists of ",dim(b_data)[1]," rows and ",dim(b_data)[2]," columns",sep=""))

#List of column names
colnames(b_data)

print(b_data[1:3,])

#Type of each column
sapply(b_data, class)

```
Notably there are many columns in the dataframe listed as numeric, but only have values 0-1

### Missing Data

The code below highlights only a few columns with missing data. These columns all relate to the result of a TB test ( screen_result, tb_triage_result, conf_sample_result, patient_conf_result_received). In the design of the baseline model, these missing values are not as a result of data being incorrcetly recorded or collected, but rather represent a status themselves - that is, no result was availble at that point in the patient pathway
```{r}
# count the missing values by column wise
print("Count of missing values by column wise")
sapply(b_data, function(x) sum(is.na(x)))
```


### HIV and TB summary

```{r}
#Group by hiv and TB status and count
hiv_tb_counts=b_data %>% group_by(tb_status,hiv) %>% count() 
hiv_tb_counts$hiv_status="hiv_pos"
hiv_tb_counts$hiv_status[hiv_tb_counts$hiv==0]="hiv_neg"
hiv_tb_counts$hiv=NULL
hiv_tb_counts=hiv_tb_counts%>% spread(hiv_status,n)

print(hiv_tb_counts)

#Summarise counts
print(paste("Total HIV positive: ", sum(hiv_tb_counts$hiv_pos),sep=""))
print(paste("Total HIV Negative: ", sum(hiv_tb_counts$hiv_neg),sep=""))
print(paste("Total EPTB: ", hiv_tb_counts$hiv_neg[hiv_tb_counts$tb_status=="eptb"]+hiv_tb_counts$hiv_pos[hiv_tb_counts$tb_status=="eptb"],sep=""))
print(paste("Total PTB: ", hiv_tb_counts$hiv_neg[hiv_tb_counts$tb_status=="ptb"]+hiv_tb_counts$hiv_pos[hiv_tb_counts$tb_status=="ptb"],sep=""))
print(paste("Total TB positive: ", hiv_tb_counts$hiv_neg[hiv_tb_counts$tb_status=="eptb"]+hiv_tb_counts$hiv_pos[hiv_tb_counts$tb_status=="eptb"]+hiv_tb_counts$hiv_neg[hiv_tb_counts$tb_status=="ptb"]+hiv_tb_counts$hiv_pos[hiv_tb_counts$tb_status=="ptb"],sep=""))
print(paste("Total TB Negative: ", hiv_tb_counts$hiv_neg[hiv_tb_counts$tb_status=="tb_negative"]+hiv_tb_counts$hiv_pos[hiv_tb_counts$tb_status=="tb_negative"],sep=""))

```


### TB patient pathway summary
Given the format of the model, it is useful to summarise the number of individuals reaching key points in the patient pathway. An initial analysis is conducted only for those people with TB. Based on descriptions of the model, key variables representing some some of these points are: tb_present, tb_seek_care,tb_confirmatory_offered,conf_sample_provided,patient_conf_result_received. Summarising these variables will provide an indiciatio of how many individuals with TB reach each point in the pathway and are diagnoses corrcetly.


```{r}
#Filter to only those with TB
b_data_tb_path=b_data %>% filter(tb_present==1) %>% select(tb_present, tb_seek_care,tb_confirmatory_offered,conf_sample_provided,
                                                           ,patient_conf_result_received)

#Count pathway points
tb_path_counts=data.frame(colSums(b_data_tb_path,na.rm=TRUE))
colnames(tb_path_counts)[1]="count"
tb_path_counts$variable=rownames(tb_path_counts)

#Determine percentages
tb_path_counts$perc=round(tb_path_counts$count/max(tb_path_counts$count)*100,1)

#Plot tB cascade

ggplot(tb_path_counts,aes(x=reorder(variable,-count),y=count))+
  geom_bar(stat="identity")+theme_bw()+xlab("Pathway Point")+ylab("Number of individuals")+
  labs(title="Percentage of individuals with TB reaching \n differents points in the patient diagnostic journey")+
  geom_text(aes(x=reorder(variable,-count),y=count+25,label=paste(perc,"%",sep="")))+
   scale_x_discrete(guide = guide_axis(n.dodge=2))
```


# Data Description: WHO Tuberculosis Data

This dataset represent thw WHO TB estimates for Kenya. 


## Load and merge WHO TB burden data and data dictionary
```{r}

#Path to directory
basePath="/Users/adenooy/Library/CloudStorage/OneDrive-Personal/UVA/Thesis/MSc-Thesis/"

#Load data dictionary
datadict=read.csv(paste(basePath,"data/dynamic/TB_data_dictionary_2024-01-30.csv",sep=""))
colnames(datadict)

print(datadict[1:3,])

#Load TB data
tb_estimates=read_excel(paste(basePath,"data/dynamic/kenya_tb_burden.xlsx",sep=""))
colnames(tb_estimates)
print(tb_estimates[1:3,])

#Merge tb data with data dictionary
tbData=tb_estimates %>% gather("variable_name","value",7:50) %>% left_join(datadict)


#remove unnecessary regional columns, blank code_list column
tbData=subset(tbData, select = -c(iso2,iso3,iso_numeric,g_whoregion,code_list) )
print(tbData[1:5,])

```
### Structure of combined dataset and data dictionary

```{r}

print(paste("The dataframe consists of ",dim(tbData)[1]," rows and ",dim(tbData)[2]," columns",sep=""))

#List of column names
colnames(tbData)

print(tbData[1:3,])

#Type of each column
sapply(tbData, class)

```
### Exploring WHO variables 
Within the dataset there are multiple indicators listed under the column variable_name, each representing a certain measurement or quantity related to TB. Not all of these will be relevant to the model calibration but it is important to see what is available to determine those which are the most useful. 

Notably, indicator values are presented yearly over an approximate two decade period between 2000-2022

```{r}
#List individual indicators
tbData_vars=tbData$variable_name %>% unique()
print(tbData_vars)

print(paste("Within the dataset there are ", length(tbData_vars)," indicators. Most indicators are grouped into categories of three with a mean, lower and upper bound",sep=""))

#Time period
tbData_time=tbData$year  %>% unique()
print(list(tbData_time))
```


## Exploring new incident infections (all infections and HIV)

Incident infections are the number of estimated people being infected with and acquiring active TB each year. The number of new infections is an estimate and is different from the number of reported cases or diagnoses - which is reliant on the identification, testing and treating of people with TB.  This data represents a key element in the transmisison model and it is important in understanding the past dynamics of TB in kenya and provides an idea on the current trend. 

HIV is an important  factor to consider, given that Kenya has relatively high HIV/TB coinfection and because HIV impacts the likelihood of contracting TB, becoming infectious or of becoming severely ill. 

```{r,fig.width = 6, fig.height = 4}
#select relevant variables related to incidence
inc_data= tbData %>% filter(variable_name %in% c("e_inc_num","e_inc_num_lo","e_inc_num_hi")) %>% mutate(var="e_inc_num") 
hiv_inc=tbData %>% filter(variable_name%in% c("e_inc_tbhiv_num","e_inc_tbhiv_num_lo","e_inc_tbhiv_num_hi"))%>% mutate(var="e_inc_tbhiv_num")
hiv_perc_inc=tbData %>% filter(variable_name%in% c("e_tbhiv_prct","e_tbhiv_prct_lo","e_tbhiv_prct_hi"))%>% mutate(var="e_tbhiv_prct")

#label upper, lower and mean estimates
all_inc=rbind(inc_data,hiv_inc)
all_inc$est_type="Mean"
all_inc$est_type[grepl("_lo",all_inc$variable_name,fixed=TRUE)==TRUE]="Lower"
all_inc$est_type[grepl("_hi",all_inc$variable_name,fixed=TRUE)==TRUE]="Upper"

hiv_perc_inc$est_type="Mean"
hiv_perc_inc$est_type[grepl("_lo",hiv_perc_inc$variable_name,fixed=TRUE)==TRUE]="Lower"
hiv_perc_inc$est_type[grepl("_hi",hiv_perc_inc$variable_name,fixed=TRUE)==TRUE]="Upper"

#Incident cases (all and HIV)
ggplot(all_inc,aes(x=year,y=value,group=variable_name,color=est_type))+geom_point()+
  geom_line()+theme_bw()+xlab("Year")+ylab("Number of cases")+
  labs(title="Estimated number of new cases per year")+theme(legend.position = "bottom")+facet_wrap(.~var)

#Percentage of new cases HIV positive
ggplot(hiv_perc_inc,aes(x=year,y=value,group=variable_name,color=est_type))+geom_point()+
  geom_line()+theme_bw()+xlab("Year")+ylab("Number of cases")+
  labs(title="Estimated number of new cases per year")+theme(legend.position = "bottom")+facet_wrap(.~var)


```

## Exploring mean estimates of key factors - population, incidence, case detection, mortality (for whole population)

Key definitions from WHO indicator metadata registry and estimate methedology appendix \
- Case Detection rate (%) : Proportion of estimated new and relapse TB (incident) cases diagnosed in a year \
-Number of deaths: Product of incidence and case fatality rate\
-Case fatality rate: risk of death among people with active (incident) TB, adapte dto account fro low covergae/reporting\

```{r, fig.width = 6, fig.height = 4}
#Collect key factors relevant to understanding the dynamics of TB transmission
key_fact=tbData %>% filter(variable_name %in% c("e_pop_num","e_inc_num","e_inc_rr_num","e_mort_num","c_cdr","cfr","cfr_pct")) %>% 
  select(variable_name,year,value) %>% spread(variable_name,value)


#Conduct additional caluclations fo rates or use rates to estimate numbers
key_fact$calc_cfr_inc=100*(key_fact$e_mort_num/key_fact$e_inc_num)
key_fact$calc_case_detect=key_fact$c_cdr/100*key_fact$e_inc_num
key_fact$calc_cfr_case=100*(key_fact$e_mort_num/key_fact$calc_case_detect)
key_fact$deaths_cal=key_fact$cfr*key_fact$e_inc_num

#Add user friendly labels
variable=c("e_pop_num","e_inc_num","e_inc_rr_num","e_mort_num","c_cdr","cfr","cfr_pct","calc_case_detect")
labels=c("Population","Incident Cases","Incident RR Cases","Deaths","Case Detection Rate","Case fatality Rate","Case Fatality Rate (%)","Cases Detected")
labs=data.frame(cbind(variable,labels))

#Plot key factors with absolute numbers (other than population)
key_fact_num=key_fact %>% select(year,e_inc_num,calc_case_detect,e_mort_num) %>% gather("variable","value",2:4) %>% left_join(labs)
ggplot(key_fact_num,aes(x=year,y=value,group=variable,colour=labels))+geom_point()+geom_line()+theme_bw()+
  labs(title="Number of incident cases, cases detected and deaths")+ylab("Number of individuals")+theme(legend.position = "bottom")

#Plot key factors which are rates
key_fact_rate=key_fact %>% select(year,c_cdr,cfr_pct) %>% gather("variable","value",2:3)%>% left_join(labs)
ggplot(key_fact_rate,aes(x=year,y=value,group=variable,colour=labels))+geom_point()+geom_line()+theme_bw()+
  labs(title="Case detection and case fatality rates over time")+ylab("Percent(%)")+theme(legend.position = "bottom")




```


## Set up calibration data for transmission model

The transmission model will be calibrated against data from this set. In this case incidence data over time will be the key comparator, however, later it will be useful to compare other variables - like cases detected.

```{r}
#Collect incidence data in correct format - key variables and wide format
cal_data=all_inc %>% select(year, var,est_type,value) %>% spread(est_type,value) %>% filter(var=="e_inc_num")

#Save data
write.csv(cal_data,"/Users/adenooy/Library/CloudStorage/OneDrive-Personal/UVA/Thesis/MSc-Thesis/data/dynamic/calibration_incidence.csv")


```


